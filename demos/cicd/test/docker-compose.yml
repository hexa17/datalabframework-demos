version: '3'
services:
  concourse-db:
    image: postgres
    environment:
    - POSTGRES_DB=concourse
    - POSTGRES_PASSWORD=concourse_pass
    - POSTGRES_USER=concourse_user
    - PGDATA=/database
    networks:
     - datalabframework

  concourse:
    image: concourse/concourse
    command: quickstart
    privileged: true
    depends_on: [concourse-db]
    ports: ["18080:8080"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
    - CONCOURSE_POSTGRES_HOST=concourse-db
    - CONCOURSE_POSTGRES_USER=concourse_user
    - CONCOURSE_POSTGRES_PASSWORD=concourse_pass
    - CONCOURSE_POSTGRES_DATABASE=concourse
    - CONCOURSE_EXTERNAL_URL=http://localhost:18080
    - CONCOURSE_ADD_LOCAL_USER=test:$$2a$$10$$0W9/ilCpYXY/yCPpaOD.6eCrGda/fnH3D4lhsw1Mze0WTID5BuiTW
    - CONCOURSE_MAIN_TEAM_ALLOW_ALL_USERS=true
    - CONCOURSE_WORKER_GARDEN_NETWORK
    networks:
     - datalabframework

  registry:
    image: registry:2
    ports: ["5000:5000"]
    restart: always
    volumes:
      - /mnt/registry:/var/lib/registry
    networks:
     - datalabframework

  spark-master:
    image: natbusa/pyspark-notebook
    command: /usr/local/spark/bin/spark-class org.apache.spark.deploy.master.Master -h spark-master
    hostname: spark-master
    environment:
      MASTER: spark://spark-master:7077
      SPARK_PUBLIC_DNS: localhost
    ports:
      - 7077:7077
      - 8080:8080
    volumes:
      - ./volumes/spark/master/data:/tmp/data
    networks:
     - datalabframework

  spark-worker-1:
    image: natbusa/pyspark-notebook
    command: /usr/local/spark/bin/spark-class org.apache.spark.deploy.worker.Worker spark://spark-master:7077
    hostname: spark-worker-1
    environment:
      SPARK_WORKER_CORES: 2
      SPARK_WORKER_MEMORY: 1g
      SPARK_WORKER_PORT: 8881
      SPARK_WORKER_WEBUI_PORT: 8081
      SPARK_PUBLIC_DNS: localhost
    ports:
      - 8081:8081
    volumes:
      - ./volumes/spark/worker-1/data:/tmp/data
      - ./volumes/spark/worker-1/work:/usr/local/spark/work
    networks:
     - datalabframework

  spark-worker-2:
    image: natbusa/pyspark-notebook
    command: /usr/local/spark/bin/spark-class org.apache.spark.deploy.worker.Worker spark://spark-master:7077
    hostname: spark-worker-2
    environment:
      SPARK_WORKER_CORES: 2
      SPARK_WORKER_MEMORY: 1g
      SPARK_WORKER_PORT: 8881
      SPARK_WORKER_WEBUI_PORT: 8081
      SPARK_PUBLIC_DNS: localhost
    ports:
      - 8082:8081
    volumes:
      - ./volumes/spark/worker-2/data:/tmp/data
      - ./volumes/spark/worker-2/work:/usr/local/spark/work
    networks:
     - datalabframework

networks:
  datalabframework:
